<html>
<head>
	<style>
		body {
			margin: 0px;
    		background-color: darkgreen;
		}
		.declareBtn {
		    /*background-color: darkblue;*/
		    min-width: 80px;
		}
		#header{
			background-color: black;
			color: white; 
			text-align: center;
			width: 100%;
			font-size: x-large;
		}
		#content{
    		margin: auto;
   	 		max-width: 600px;
    		position: relative;
    		/*background-color: darkgray;*/
    		transform: scale(0.95);
		}
		.name{
		    color: white;
		    font-weight: bolder;
		    font-family: sans-serif;
		}
		.dealer {
			border: black;
			border-style: solid;				
		}
		.bidn {
			background: firebrick;
		    font-size: xx-large;
		    width: 180px;
		    height: auto;
		    text-align: center;
		    border-radius: 40px;
		    padding: 10px;		
		    color: lightgrey;	
		}
		.bid {
		    color: black;
		    background-color: white;
		    border-color: black;
		    border-style: solid;
		    border-radius: 50px;
		    position: absolute;
		    padding: 15px;
    		}
		#bidn1 {
		    position: absolute;
		    top: 0px;
		}
		#bidn2 {
			position: absolute;
		    top: 0px;
		    right: 0px;
		}
		#bidn3 {
		    position: relative;
		    top: 180px;
		    margin: auto;
			}			
		#bidding{
		    position: absolute;
		    top: 600px;
		    /* left: 180px; */
		    /* background: green; */
		    font-size: xx-large;
		    width: 100%;
		    height: auto;
		    text-align: center;
		    z-index: 999;
		}	
		#picking{
		    position: absolute;
		    top: 600px;
		    /* left: 180px; */
		    /* background: green; */
		    font-size: xx-large;
		    width: 100%;
		    height: auto;
		    text-align: center;
		}			
		#bidBtn {
			width: 30%;
		}		
		#passBtn {
			width: 30%;
		}				
		.card {
			width: 130px;
			height: auto;
			transition: 0.3s ease-in-out;
			border-radius: 0px;
		}
		.card:hover {
			transform:translate(0,-1em) scale(1.2);
		}
		#cards {
			position: absolute;
			top: 410px;
			left:0px;
			background: none;
			/*background-color: green;*/
			width: 100%;
		}
		.btn {
			font-size: xx-large;
			border-radius: 10px;
			padding: 5px;
			margin: 1px;
			background-color: orange;					
		}		
		#played {
			position: relative;
			top: 0px;
			/*left:240px;*/
			transition: 1s ease-in-out;
			transform: scale(0.9);
			width: 100px;
			height: 0px;
			margin: auto;
			z-index: 10	;
		}

		#previous {
			position: absolute;
		    top: 200px;
		    left: 0px;
		    transform: scale(0.5);
		}

		#played1 {
			position:absolute;
			top: 0px;
			left: -40px;
			transform: rotate(-15deg);
		}
		#played3 {
			position:absolute;
			top: 40px;
			left: 0px;
			transform: rotate(2deg);
		}			
		#played2 {
			position:absolute;
			top: -3px;
			left: 40px;
			transform: rotate(11deg);
		}			
		#score {
		    position: relative;
		    top: 200px;
		    /*left: 200px;*/
		    font-size: xx-large;
		    font-weight: bolder;
		    color: white;
		    background-color: gray;
		    border-radius: 10px;
		    padding: 20px;
		    visibility: hidden;
			text-align: center;		    
		}
		#pickBtn {

		}
		#handBtn {

		}

		#declare {
			/*margin: auto;*/
		    top: 600px;
		    width:100%;
		    position: absolute;
		    text-align: center;	
		}
    	#discard {
			position: absolute;
		    top: 600px;
		    /* left: 0; */
		    width: 100%;
		    margin: auto;
		    text-align: center;
    	}			
		#discardBtn {
			width: 270px;
		}
		#messageDiv {

		    width: 100%;
		    z-index: 999;
		    position: absolute;	
		    top: 530px;		
		}
		#message {
		    position: relative;	
		    margin: auto; 	
			font-size: xx-large;
		    background-color: gray;
		    color: white;
		    opacity: 0.75;
		    border-radius: 20px;
		    padding: 20;
		    text-align: center;
		    max-width: 350px;
		    min-width: 150px;
		}
		#main {
			width: 400px; 
			margin: auto;
			position:relative;
			height: 60px;
		}
		#players {
			position: relative;
		}

	</style>
</head>
<body>
	<div id="header">Hi! Ola! Ciao!</div>
	<div id="content">
		<div id="main">
			<button id="startBtn" class="btn" onclick="start()" style="width: inherit;">Start a new game</button>
		</div>
		<div id="players">
			<div id="played"></div>
			<div id="previous"></div>

			<div id="bidn1" class="bidn">
				<div id="name1" class="name">Bob</div>
				<div id="bid1" class="bid"></div>
			</div>

			<div id="bidn2" class="bidn">
				<div id="name2" class="name">Ana</div>
				<div id="bid2" class="bid"></div>
			</div>

			<div id="bidn3" class="bidn">	
				<div id="name3" class="name">You</div>
				<div id="bid3" class="bid"></div>
			</div>	

		</div>

		<div id="bidding" style="display: none;">
			<button id="bidBtn" class="btn">XX</button>
			<button id="passBtn" class="btn">Pass</button>
		</div>

		<div id="cards"></div>
		<div id="score"></div>

		<div id="picking" style="display: none;">
			<button id="pickBtn" class="btn">Pick up the skat</button>
			<button id="handBtn" class="btn">Play Hand Game</button>
		</div>
		<div id="declare" style="display: none;">
			<button id="clubs" class="btn">CLUBS</button>
			<button id="spade" class="btn">SPADES</button>
			<button id="heart" class="btn">HEARTS</button>
			<button id="caro" class="btn">DIAMONDS</button>
			<button id="grand" class="btn">Grand</button>
			<button id="null" class="btn">Null</button>
		</div>
		<div id="discard" style="display: none;"></div>
		<div id="messageDiv">
			<div id="message"style="display: none;">ALL PASSED</div>
		</div>
	</div>
<script type="text/javascript" src="/html/jquery-3.2.1.min.js"></script>
<!-- <script type="text/javascript" src="/html/jquery-ui.min.js"></script> -->
<script type="text/javascript">


		$("#bid1").hide();
		$("#bid2").hide();
		$("#bid3").hide();	


	function start() {
		// UNCOMMENT FOR REAL GAME
		document.getElementById("startBtn").style["visibility"] = "hidden";
		document.getElementById("score").style["visibility"] = "hidden";

		$("#bid1").empty();
		$("#bid2").empty();
		$("#bid3").empty();

		$("#bid1").hide();
		$("#bid2").hide();
		$("#bid3").hide();		

		$("#cards").empty();
				
		$.ajax({
			url: "/start",
			method: "GET",
			success: handleInitData,
		});

		return false;
	}

// FORE = 0, MID=1, BACK=2
	var passed = [false, false, false]
	var biddiv = ["#bid1", "#bid2", "#bid3"]
	var playerIndex= [1,2,3]
	var prevPlayerIndex= []

	var gamePosition = -1;
	var secondRound = false;
	var parsedBid = "";
	var acceptedBid = "";
	var playerHand= [];
	var declarer =  -1;
	var lostNull = false;
	var trump = "";
	var handGame = true;
	var youIndex = -1;
	var trickIndex = -1;
	var enableClick = false;
	var skatPos1 = -1;
	var skatPos2 = -1;


	function showNameScores(s1, s2, s3) {
		$("#name1").html("Bob (" + s2 + ")");
		$("#name2").html("Ana (" + s3 + ")")
		$("#name3").html("You (" + s1 + ")")
	}

	function handleInitData(rawData) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		setPlayerHandFromServer(parsed.Hand);
		showNameScores(parsed.Score1, parsed.Score2, parsed.Score3);
		var headerText = "Game " + parsed.Game;
		gamePosition = parsed.Position
		youIndex = gamePosition
		console.log("Position "+ gamePosition);
		if (gamePosition == 0) {
			biddiv = ["#bid3", "#bid1", "#bid2"]
			playerIndex = [3, 1, 2]
			$("#bidn1").removeClass("dealer");
			$("#bidn2").addClass("dealer");
			$("#bidn3").removeClass("dealer");
			headerText += ". Ana deals the cards. You are forehand"
		}
		if (gamePosition == 1) {
			biddiv = ["#bid2", "#bid3", "#bid1"]
			playerIndex = [2, 3, 1]
			$("#bidn1").addClass("dealer");
			$("#bidn2").removeClass("dealer");
			$("#bidn3").removeClass("dealer");
			headerText += ". Bob deals the cards. You are middlehand"
		}
		if (gamePosition == 2) {
			biddiv = ["#bid1", "#bid2", "#bid3"]
			playerIndex = [1, 2, 3]
			$("#bidn1").removeClass("dealer");
			$("#bidn2").removeClass("dealer");
			$("#bidn3").addClass("dealer");
			headerText += ". You deal the cards, you are backhand"
			toastMsg("You deal the cards")
		}				
		passed = [false, false, false];
		secondRound = false;
		parsedBid = "";
		acceptedBid = "";
		trickRound = 0;
		declarer = -1;
		lostNull = false;
		trump = "";		
		selectedToDiscard = []

		// for (var i=1; i <=3 ; i++) 
		// 	document.getElementById("bidn" + i).style["background"] = "yellow"			

		$("#header").text(headerText);

		MidVsFore();
	}

	function getPickUp() {
		return new Promise(function(resolve) {

			$("#picking").empty()
			$("#picking").append($('<button id="pickBtn" class="btn">Pick up skat</button>'))
			$("#picking").append($('<button id="handBtn" class="btn">Play Hand Game</button>'))
			$("#picking").show();

			var pickBtn = document.getElementById("pickBtn")
			var handBtn = document.getElementById("handBtn")
			pickBtn.addEventListener('click', function() {
				$("#picking").hide();
				resolve("pick")
			}) 
			handBtn.addEventListener('click', function() {
				$("#picking").hide();
				resolve("hand")
			}) 	
		});
	}

	function getHandFromServer() {
		return Promise.resolve($.ajax({
			url: "/getHand/" + gamePosition,
			method: "GET",
			success: function(rawdata) {
				var parsed = JSON.parse(rawdata);
				if (!parsed) return;	
				setPlayerHandFromServer(parsed);
			}
		}));		
	}


	function getHandAndSkatFromServer() {
		return Promise.resolve($.ajax({
			url: "/getHandAndSkat/" + gamePosition,
			method: "GET",
			success: function(rawdata) {
				var parsed = JSON.parse(rawdata);
				if (!parsed) return;	
				setPlayerHandFromServer(parsed.Hand);
				skatPos1 = parsed.SkatPos1;
				skatPos2 = parsed.SkatPos2;
				console.log("" + skatPos1 + " " + skatPos2)
			}
		}));		
	}

	function chooseGame() {
		return new Promise(function(resolve) {
	
			$("#declare").empty()
			$("#declare").append($('<button id="clubs" class="declareBtn btn">CLUBS</button>'))
			$("#declare").append($('<button id="spade" class="btn declareBtn">SPADES</button>'))
			$("#declare").append($('<button id="heart" class="btn declareBtn">HEARTS</button>'))
			$("#declare").append($('<button id="caro" class="btn declareBtn">DIAMONDS</button>'))
			$("#declare").append($('<button id="grand" class="btn declareBtn">Grand</button>'))
			if ( !handGame && acceptedBid <= 23 || handGame && acceptedBid <= 35) {
				$("#declare").append($('<button id="null" class="btn declareBtn">Null</button>'))
				var nullGame = document.getElementById("null")
				nullGame.addEventListener('click', function() {
					$("#declare").hide();
					resolve("Null")
				}) 							
			}

			$("#declare").show();

			$("#clubs").html('<img src="/html/img/clubs.png" style="height: 30px;width: auto;position: relative;">'); 
			$("#spade").html('<img src="/html/img/spades.png" style="height: 30px;width: auto;position: relative;">'); 
			$("#heart").html('<img src="/html/img/hearts.png" style="height: 30px;width: auto;position: relative;">'); 
			$("#caro").html('<img src="/html/img/diamonds.png" style="height: 30px;width: auto;position: relative;">'); 

			var clubs = document.getElementById("clubs")
			var spade = document.getElementById("spade")
			var heart = document.getElementById("heart")
			var caro = document.getElementById("caro")
			var grand = document.getElementById("grand")
			clubs.addEventListener('click', function() {
				$("#declare").hide();
				resolve("CLUBS")
			}) 
			spade.addEventListener('click', function() {
				$("#declare").hide();
				resolve("SPADE")
			}) 	
			heart.addEventListener('click', function() {
				$("#declare").hide();
				resolve("HEART")
			}) 
			caro.addEventListener('click', function() {
				$("#declare").hide();
				resolve("CARO")
			}) 							
			grand.addEventListener('click', function() {
				$("#declare").hide();
				resolve("Grand")
			}) 							
		});
	}

	function chooseCardsToDiscard() {
		return new Promise(function(resolve) {
			$("#discard").empty()
			$("#discard").append($('<button id="discardBtn" class="btn">Discard to skat</button>'))
			$("#discard").show();
			discardCardsAddEventListeners();

			var discardBtn = document.getElementById("discardBtn")
			discardBtn.addEventListener('click', function() {
				if (selectedToDiscard.length != 2) 
					return;
				$("#discard").hide();
				var cardsToDiscard = [];
				cardsToDiscard.push(selectedToDiscard[0]);
				cardsToDiscard.push(selectedToDiscard[1]);

				youDiscardCard(selectedToDiscard[0], selectedToDiscard[1])
				.then(function() {
					resolve(cardsToDiscard);
				})
			});
			document.getElementById('card_' + (skatPos1+1)).click();
			document.getElementById('card_' + (skatPos2+1)).click();
		});
	}

	function youDiscardCard(card1, card2) {
		return Promise.resolve(
			$.ajax({
				url: "/discardCard/" + gamePosition + "/" + 
					card1.suit + "/" + card1.rank + "/" + 
					card2.suit + "/" + card2.rank,
				method: "GET",
				success: function(rawdata) {
					console.log("Successfully discarded")
				},
			})
		)		
	}

	function discardInSkat(player) {
		// console.log("DISCARD IN SKAT");
		getHandAndSkatFromServer()
		.then(chooseCardsToDiscard)
		.then(getHandFromServer)
		.then(function(response) {
			declareGame(player)
		});
	}

	function pickUpAndDeclare(player) {
		getPickUp()
		.then(function(response) {
			console.log("SENDING: " + response);
			$.ajax({
				url: "/pickUp/" + response,
				method: "GET",
				success: function(rawdata) {
					console.log(response + " Successfully sent");
					if (response == "hand") {
						handGame = true;
						declareGame(player);
					} else {
						handGame = false;
						discardInSkat(player);
					}					
				},
			})
		})
	}

	function declareGame(player) {	
		// console.log("DECLARE GAME...")
		chooseGame()
		.then(function(response) {
			// console.log(response);
			$.ajax({
				url: "/declare/" + response,
				method: "GET",
				success: function(rawdata) {
					console.log("Success")
				},
			})
		})	
		.then(function(response) {
			continueWithTrump(player)
		});
	}

	function pickUpSkat(player) {
		console.log("PICKING UP...");
		if (player != gamePosition) {
			console.log("Other player")
			continueWithTrump(player)
		} else {
			pickUpAndDeclare(player)
		}
	}

	function continueWithTrump(player) {
		console.log("Declare game")
		Promise.resolve($.ajax({
				url: "/getTrump",
				method: "GET",
				success: function(rawdata) {
					var parsed = JSON.parse(rawdata);
					if (!parsed) return;	
					trump = parsed	
					console.log("TRUMP: " + trump)
					$(biddiv[player]).append($("<div>" + trump + "</div>"));	
					$(biddiv[player]).show();				
				}
		})).then(function(response) {
			getHandFromServer()
			.then(function(response) {
				cardsPlayed = 0;
				$("#played").empty();
				trick();				
			})
		})	
	}

	var cardsPlayed = 0
	var trickRound = 0

	function getScore() {
		$.ajax({
			url: "/getScore",
			method: "GET",
			success: showScore,
		})	
	}

	function showScore(rawdata) {
		console.log("name"+playerIndex[declarer]);
		$("#message").hide();

		var parsed = JSON.parse(rawdata);
		if (!parsed) return;
		var score = document.getElementById("score")
		score.style["visibility"] = "visible"
		var text = parsed.Declarer;
		if (parsed.GameScore < 0)
			text += " lost!"
		else 
			text += " won!"
		text += "<br/>"
		if (trump != "Null") {
			text += parsed.DeclarerPoints + " - " + parsed.DefenderPoints + "<br/>"
			if (parsed.With > 0) {
				text += "With "
			} else {
				text += "Without "
			}
			val = Math.abs(parsed.With) 
			text += "" + val + ", Game "
			val++;
			text += val; 
			if (parsed.Hand) {
				val++;
				text += ", Hand " + val
			}
			if (parsed.Schneider) {
				val++;
				text += ", Schneider " + val
			}				
			if (parsed.Schwarz) {
				val++;
				text += ", Schwarz " + val
			}
		}
		if (parsed.Overbid) {
			text += "<br/>Overbid!"
		}
		text += "<br/>Score: " + parsed.GameScore;
		score.innerHTML = text;
		document.getElementById("startBtn").style["visibility"] = "visible";
		console.log("TOTALS: " + parsed.Total1 + " " + parsed.Total2 + " " + parsed.Total3 )
		showNameScores(parsed.Total1, parsed.Total2, parsed.Total3);
	}

	function gameFinished() {
		return trickRound > 10 || lostNull
	}

	function yourTurnMessage(played) {
		if (!played[0]) {
			var message = document.getElementById("message");
			message.innerHTML = "Your turn!";
			$("#message").show();
		}
		// setTimeout(function() {
		// 	if (!played[0]) {
		// 		toastMsg("Your turn!");
		// 		yourTurnMessage(played);
		// 	}
		// }, 5000);
	}

	function getCardFromServer() {
		var played = [false];
		trickIndex++;
		if (trickIndex > 2) trickIndex = 0;
		if (trickIndex == youIndex) {
			enableClick = true;
			setTimeout(function() {
				yourTurnMessage(played); 
			}, 5000);		
		}
		console.log("Getting card from server. " + gamePosition)
		console.log("YouIndex, trickIndex: " + youIndex + " " + trickIndex)
		// console.log("STARTING YOUR TURN timer")

		return Promise.resolve($.ajax({
			url: "/getCardPlayed",
			method: "GET",
			success: function(data) {
				played[0] = true;
				playCard(data);
			},
		}))
	}

	function trick() {
		var el = document.getElementById("played");
		trickRound++
		if (gameFinished()) {
			// console.log("Game finished");
			$("#previous").empty();
			
			getScore();
			trickRound = 0;
			return
		}
		getCardFromServer()
		.then(function () {
			el.style["transition"] = "1s ease-in-out";
		})
		.then(delayfn(1000))
		.then(getCardFromServer)
		.then(delayfn(600))
		.then(getCardFromServer)
		// .then(delayfn(200))
		.then(getTrickWinner)
		.then(delayfn(500))
		.then(function() {
			el.style["visibility"] = "hidden";
			el.style["transition"] = "0s";
		})
		.then(delayfn(500))
		.then(function (response) {
			$("#previous").empty();
			$("#previous").append($("#played" + prevPlayerIndex[0]))
			$("#previous").append($("#played" + prevPlayerIndex[1]))
			$("#previous").append($("#played" + prevPlayerIndex[2]))
			console.log("" + playerIndex[0] + " " + playerIndex[1] + " " + playerIndex[2] + " ")
			// jQuery("#NodesToMove").detach().appendTo('#DestinationContainerNode')
			$("#played").empty();
			showPlayed();
			trick();
		});
	}

	function delay(t) {
		return new Promise(function(resolve) {
			setTimeout(function() {
				resolve("OVER")
			}, t);
		});
	}

	// to be used after a then.
	function delayfn(t) {
		return function() {
			return delay(t);
		}
	}

	function getTrickWinner() {
		return Promise.resolve($.ajax({
			url: "/getTrickWinner",
			method: "GET",
			success: function(rawdata) {
				var parsed = JSON.parse(rawdata);
				if (!parsed) return;	
				var winner = parsed	
				// console.log("WINNER: " + parsed)

				var el = document.getElementById("played");
				prevPlayerIndex[0] = playerIndex[0]
				prevPlayerIndex[1] = playerIndex[1]
				prevPlayerIndex[2] = playerIndex[2]

				if (winner == "Bob") {
					playerIndex = [1, 2, 3];
					youIndex = 2;
					el.style["transform"] = "rotate(0deg) translate(-210px,30px) scale(0.4)";	
				}
				else if (winner == "Ana") {
					playerIndex = [2, 3, 1];
					youIndex = 1;
					el.style["transform"] = "rotate(0deg) translate(210px,30px) scale(0.4)";	
				}
				else {
					if (trump == "Null") {
						lostNull = true;
					}
					playerIndex = [3, 1, 2];	
					youIndex = 0;
					el.style["transform"] = "rotate(0deg) translate(0px,150px) scale(0.4)";	
				}
			}
		}))		
	}

	function playCard(rawdata) {
		var parsed = JSON.parse(rawdata);
		if (!parsed) return;					

		var played = $("#played");
		var name = parsed.C.Suit +parsed.C.Rank;
		var pi = playerIndex[parsed.Pi];
		console.log("getCardPlayed: " + name+ "player:" + parsed.Pi + " : " + pi);
		var img = $("<img id='played" + pi + "' class='card' src='/html/img/" + name + ".png' />");
		if (pi == 3) {
			// console.log("HIDING...")
			img = $("<img id='played" + pi + "' class='card' src='/html/img/" + name + ".png' style='display: none;'/>");
		}	
		played.append(img);	
	}

	function showPlayed() {
		var el = document.getElementById("played");
		el.style["transition"] = "0s";
		el.style["WebkitTransform"] = "";					
		el.style["transform"] = "";					
		el.style["visibility"]= "visible"
		el.style["transition"] = "0s ease-in-out";
	}

//
// BIDING
//
	function MidVsFore() {
		// console.log("calling MIDBID")
		getBid(1).then(function(response) {
			// console.log("MIDBID responded")
			if (!passed[1]) {
				// console.log("Mid Not passed")
				// console.log("calling FOREBID")
				getBid(0).then(function(response) {
					// console.log("FOREBID responded")
					if (!passed[0]) {
						// console.log("Fore Not passed")
						MidVsFore()	
					} else {
						// console.log("Fore passed")
						secondRound = true;
						BackVsMid();						
					}
				});
			} else {
				// console.log("Mid Passed")
				secondRound = true;
				BackVsFore();				
			}
		});
	}

	function BackVsFore() {
		// console.log("calling BACKBID")
		getBid(2).then(function(response) {
			// console.log("BACKBID responded")
			if (!passed[2]) {
				// console.log("Back NOT passed")
				// console.log("calling FOREBID")
				getBid(0).then(function(response) {
					// console.log("FOREBID responded")
					if (!passed[0]) {
						// console.log("Fore NOT passed")
						BackVsFore();
					} else {
						// console.log("Fore passed")
						// console.log("BACK WON")
						delay(1000).then(
							function() {
								setDeclarer(2);			
							}
						)
					}		
				});
			} else {
				// console.log("Back passed")
				if (acceptedBid == "") {
					getBid(0).then(function(response) {
						if (passed[0]) {
							toastMsg("All passed");
							document.getElementById("startBtn").style["visibility"] = "visible";
							return
						} else {
								// console.log("FORE WON" + acceptedBid);
							delay(1000).then(
								function() {
									setDeclarer(0);			
								}
							)																
						}
					})
				} else {
					// console.log("FORE WON" + acceptedBid);
							delay(1000).then(
								function() {
									setDeclarer(0);			
								}
							)											
				}
			}
		});
	}

	function BackVsMid() {
		// console.log("calling BACKBID")
		getBid(2).then(function(response) {
			// console.log("BACKBID responded")
			if (!passed[2]) {
				// console.log("calling MIDBID")
				getBid(1).then(function(response) {
					// console.log("MIDBID responded")
					if (!passed[1]) {
						// console.log("MID NOT passed")
						BackVsMid();
					} else {
						// console.log("MID passed")
						// console.log("BACK WON")
						delay(1000).then(
							function() {
								setDeclarer(2);			
							}
						)					}
				});
			} else {
				// console.log("Back passed")
				if (acceptedBid == "") {
					getBid(1).then(function(response) {
						if (!passed[1]) {
							toastMsg("All passed");
							document.getElementById("startBtn").style["visibility"] = "visible";
							return
						} else {
							// console.log("MID WON" + acceptedBid);
							delay(1000).then(
								function() {
									setDeclarer(1);			
								}
							)																
						
						}
					})
				} else {
					// console.log("MID WON" + acceptedBid);
							delay(1000).then(
								function() {
									setDeclarer(1);			
								}
							)					}									
			}
		});
	}

	function toastMsg(text) {
		var message = document.getElementById("message");
		message.innerHTML = text;
		//console.log(text)
		emptyBidDivsExcept(-1);
		$("#message").show();
		setTimeout(function() {
			$("#message").hide();
		}, 2000);
	}

	function setDeclarer(player) {
		($.ajax({
			url: "/declarer/" + player + "/" + acceptedBid,
			method: "GET",
			success: function(rawdata) {
				console.log("Declarer set:" + player + " BID: " + acceptedBid)

				var bid = document.getElementById("bid" + playerIndex[player])
				// console.log("Setting: element: " + "bid" + playerIndex[player])
				emptyBidDivsExcept(player);
				$(biddiv[player]).empty();
				$(biddiv[player]).hide();
				var bid = $(biddiv[player]);
				// console.log("APPENDING accepted bid: "+acceptedBid)
				bid.append($("<span>Bid: " + acceptedBid + "</span>"));
				bid.show()
				//
				// continue with pick up skat
				//
				declarer = player;
				pickUpSkat(player);
			},
		}));
	}

	function emptyBidDivsExcept(p, t) {
		setTimeout(function() {
			for (i = 0; i < 3; i++) {
				if (i != p && i != declarer) {
					$(biddiv[i]).empty();
					$(biddiv[i]).hide();
	 				// console.log("EMptying div: " + biddiv[i] + "declarer: " + declarer)
				}
			}
		}, t);	
	}

	function inputPromise(player) {
		return new Promise(function(resolve, reject) {
			Promise.resolve($.ajax({
				url: "/getbidvalue/" + player,
				method: "GET",
				success: function(rawdata) {
						var parsed = JSON.parse(rawdata);
						if (!parsed) return;
						parsedBid = parsed.Bid;
					},
			})).then(function(response) {
				// console.log("jsPromise returned. Bid: " + parsedBid);

				$("#bidding").empty()
				$("#bidding").append($('<button id="bidBtn" class="btn">XX</button>'))
				$("#bidding").append($('<button id="passBtn" class="btn">Pass</button>'))
				$("#bidding").show();

				var bidBtn = document.getElementById("bidBtn")
				var passBtn = document.getElementById("passBtn")
				if (player == 0 || (player == 1 && secondRound)) {
					text = "Yes (" + parsedBid + ")"
				} else {
					text = parsedBid
				}					
				bidBtn.innerHTML = text;
				bidBtn.addEventListener('click', function() {
					// console.log("BTN ACCEPTED")
					acceptedBid = parsedBid
					$("#bidding").hide();
					emptyBidDivsExcept(player, 500);
					resolve("OK")
				}) 
				passBtn.addEventListener('click', function() {
					passed[player] = true
					$("#bidding").hide();
					emptyBidDivsExcept(player, 500);
					resolve("PASS")
				}) 	
			})
		});
	}

	function getBid(player) {
		if (gamePosition == player) {
			return inputPromise(player);
		} else {		
			return Promise.resolve($.ajax({
				url: "/bid/" + player,
				method: "GET",
				success: function(rawdata) {
					handleBidData(rawdata, player)
				},
			}));		
		}
	}
	function handleGetBidData(rawData, player) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		parsedBid = parsed.Bid
	}
		
	function handleBidData(rawData, player) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		console.log("player " + player + ": Bid "+ parsed.Bid + " Accepted " + parsed.Accepted);
		var bid = $(biddiv[player]);
		bid.empty();

		parsedBid = parsed.Bid
		if (parsed.Accepted) {
			passed[player] = false
			console.log("...ACCEPTED")
			if (player == 0 || (player == 1 && secondRound)) {
				text = "YES (" + parsed.Bid + ")"
			} else {
				text = parsed.Bid
			}
			acceptedBid = parsed.Bid
			emptyBidDivsExcept(player, 500);	
		} else {
			console.log("...PASS")

			text = 'PASS'
			passed[player] = true
		}
		bid.append($("<span>" + text + " </span>"));
		bid.show();
	}

//
// CARDS
//


	var selectedToDiscard = [];

	function discardCardsAddEventListeners() {
		createImgElements(playerHand);

		var cards = document.getElementById("cards").children;
		for (i = 0; i < cards.length; i++) {
			var element = cards[i]
			cards[i].addEventListener('click', (function(i) {
				return function() {
					// console.log("Index: " + i);
					// console.log("discardCardClickListener DISCARD : " + cardString(playerHand[i]));
					var index = selectedToDiscard.indexOf(playerHand[i])
					// console.log("FOUND index: " + index);
					if (index == -1) {
						selectedToDiscard.push(playerHand[i]);
						this.style["top"] = "-50px";
						this.style["left"] = card_left[i] + (i-6) * 5 + "px";
					}
					else {
					 	selectedToDiscard.splice(index, 1);
						this.style["top"] = card_top[i] ;
						this.style["left"] = card_left[i] ;
					}
					// console.log(cardListString(selectedToDiscard));
				}				
			})(i) ); 
		} 
	}

	function cardString(c) {
		return c.suit + "_" + c.rank;
	}

	function cardListString(cs) {
		s = "--> / ";
		cs.forEach(function(c) {
			s = s + cardString(c) + " / "; 
		})
		return s
	}

	function cardsAddEventListeners() {
		var cards = document.getElementById("cards").children;
		for (i = 0; i < cards.length; i++) {
			cards[i].addEventListener('click', cardClickListener(i)); 
		} 
	}

	function cardClickListener(i) {
		return function() {
			// console.log("cardClickListener: " + playerHand[i].suit + " " + playerHand[i].rank)
			if (enableClick) {
				enableClick = false;
				youPlayCard(i);			
			}
		}
	}

	function youPlayCard(n) {
		// console.log(playerHand[n].suit + " " + playerHand[n].rank)
		$.ajax({
				url: "/playCard/" + gamePosition + "/" + playerHand[n].suit + "/" + playerHand[n].rank,
				method: "GET",
				success: function(rawdata) {
					console.log("Success from server: " + playerHand[n].suit + " " + playerHand[n].rank);

					$("#message").hide();

					var el = document.getElementById("card_" + (n+1));
					el.style["position"] = "absolute";
					el.style["left"] = "248px";
					el.style["top"] = "-324px";
					el.style["width"] = "130px";
					el.style["transform"] = "rotate(2deg) scale(0.9)";
					el.style["z-index"] = "100";

					delay(300).then(function() {
						$("#played3").show(); // hidden on creation
						playerHand.splice(n, 1);
						// copy playerHand to a new array to pass by value to setPlayerHand
						var l = playerHand.length;	
						var hand = Array(l);
						while(l--) hand[l] = playerHand[l];
						setPlayerHand(hand);			
					});
				},
				error: function(errValue) {
					toastMsg("You must follow suit!");
					enableClick = true;
				}
			});			
	}

	function setPlayerHand(hand) {
		// console.log("HAND " + cardListString(hand));
		playerHand = []
		hand.forEach(function(result) {
			playerHand.push(result)
		});
		// console.log("PLAYER HAND " + cardListString(playerHand));

		createImgElements(playerHand);
		cardsAddEventListeners();
	}


	function setPlayerHandFromServer(hand) {
		playerHand = []
		hand.forEach(function(result) {
			playerHand.push({suit: result.Suit, rank: result.Rank})
		});
		// console.log("PLAYER HAND " + cardListString(playerHand));

		createImgElements(playerHand);
		cardsAddEventListeners();
	}	

	function createImgElements(playerHand) {
		setImgParams(playerHand);
		var i = 0
		var cards = $("#cards");
		cards.empty();
		noOfCards = playerHand.length;
		playerHand.forEach(function(result) {
			var name = result.suit + result.rank
			var img = $("<img id='card_" + (i+1) + "' class='card' src='/html/img/" + name + ".png' onmouseover='mo(" + i + ")' onmouseleave='mv(" + i + ")' />"
						);
			cards.append(img);
			if (declarer == -1) 
				stackCard(i);
			else
				placeCard(i);
			i++
		});	
		if (declarer == -1) {
		delay(500).then(function() {
				for (i = 0; i < playerHand.length; i++) {
					placeCard(i);
				}	
			});
		}

	}

	var card_left = []
	var card_top = []
	var card_rotate = []

	var initRotate = -15
	var initTop = -10

	function setImgParams(playerHand) {
		var len = playerHand.length;
		// console.log("len: " + len);

		middleLeft = 235;
		cardwidth = 130;
		var maxWidth = 600;
		leftStep = Math.floor((maxWidth - cardwidth - 20) / playerHand.length)
		if (leftStep > 60) 
			leftStep = 60;
		// console.log("leftStep" + leftStep);
		middleTop = 0
		topStep = 4
		rotateStep = 4
		if (len % 2 == 0) {
			var half = len / 2;
			midLeft = half - 1;
			midRight = half
			for(var i=0; i < half; i++) {

				card_left[midLeft-i] = middleLeft - i * leftStep - leftStep/2
				card_left[midRight+i] = middleLeft + (i+1) * leftStep - leftStep/2
				card_top[midLeft-i] = Math.floor(middleTop + i * (topStep + i/2))
				card_top[midRight+i] = Math.floor(middleTop + i * (topStep + i/2))
				card_rotate[midLeft-i] = "rotate("+ (-rotateStep/2 - i *rotateStep) +"deg)"
				card_rotate[midRight+i] = "rotate("+ (rotateStep/2 + i * rotateStep) +"deg)"
			}				
		} else {
			var half = Math.floor(len / 2);
			middle = half;
			midLeft = half - 1;
			midRight = half + 1;
			// console.log("Setting: " + (middle));
			// console.log("position: " + (middleLeft))  
			card_left[middle] = middleLeft
			card_top[middle] = middleTop
			card_rotate[middle] = "rotate(0deg)"
			for(var i=0; i < half; i++) {
				card_left[midLeft-i] = middleLeft - (i+1) * leftStep
				card_left[midRight+i] = middleLeft + (i+1) * leftStep
				card_top[midLeft-i] = Math.floor(middleTop + i * (topStep + i/2))
				card_top[midRight+i] = Math.floor(middleTop + i * (topStep + i/2))
				card_rotate[midLeft-i] = "rotate("+ (- (i+1) *rotateStep) +"deg)"
				card_rotate[midRight+i] = "rotate("+ ((i+1) * rotateStep) +"deg)"
			}				
		}
	
	}


	function mo(id) {
		var el = document.getElementById("card_" + (id+1));
		el.style["WebkitTransform"] = card_rotate[id] + " translate(0,-1em) scale(1.1)";
	}

	function mv(id) {
		var el = document.getElementById("card_" + (id+1));
		el.style["WebkitTransform"] = card_rotate[id];
	}

	function placeCard(id) {
		// console.log("Placing card " + id);
		var el = document.getElementById("card_" + (id+1));
		el.className = 'card'
		el.style["left"] = card_left[id] + "px";
		el.style["top"] = card_top[id] + "px";
		if (id == 0) {
			el.style["position"] = "relative"
		} else {
			el.style["position"] = "absolute";
		}
		el.style["WebkitTransform"] = card_rotate[id];
		el.style["transform"] = card_rotate[id];
	}

	function stackCard(id) {
		// console.log("Stacking card " + id);

		var el = document.getElementById("card_" + (id+1));
		el.className = 'card'
		el.style["left"] = "235px";
		el.style["top"] = "-10px";
		if (id == 0) {
			el.style["position"] = "relative"
		} else {
			el.style["position"] = "absolute";
		}
		el.style["WebkitTransform"] = "rotate(0deg)";
		el.style["transform"] = "rotate(0deg)";
	}

</script>
</body>
</html>