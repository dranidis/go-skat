<html>
<head>
		<style>
			.name{
				color: blue;
    			font-style: italic;
			}
			.dealer {
    			border: black;
    			border-style: solid;				
			}
			#bidn1 {
			    position: absolute;
			    top: 50px;
			    left: 50px;
			    background: yellow;
			    font-size: xx-large;
			    width: 150px;
			    height: auto;
			    text-align: center;
				border-radius: 200px;
			}
			#bidn2 {
			    position: absolute;
			    top: 50px;
			    left: 450px;
			    background: yellow;
			    font-size: xx-large;
			    width: 150px;
			    height: auto;
			    text-align: center;
				border-radius: 200px;
			}
			#bidn3 {
			    position: absolute;
			    top: 250px;
			    left: 250px;
			    background: yellow;
			    font-size: xx-large;
			    width: 150px;
			    height: auto;
			    text-align: center;
				border-radius: 200px;
			}			
			#bidding {
			    position: absolute;
			    top: 340px;
			    left: 180px;
			    /*background: green;*/
			    font-size: xx-large;
			    width: 300px;
			    height: auto;
			    text-align: center;
			}			
			.card {
				width: 100px;
				height: auto;
				transition: 0.3s ease-in-out;
				border-radius: 0px;
			}
			.card:hover {
				transform:translate(0,-1em) scale(1.2);
			}
			#cards {
				position: relative;
				top: 350px;
				left:50px;
				background: none;
			}
			#discard1 {
				position: absolute;
				top: 30px;
				left:250px;
				background: red;
			}		
			#discard2 {
				position: absolute;
				top: 30px;
				left:400px;
				background: green;
			}
			.btn {
			    font-size: xx-large;
    			border-radius: 10px;					
			}		
			#played {
				position: absolute;
				top: 50px;
				left:240px;
				transition: 1s ease-in-out;
			}

			#played1 {
				position:absolute;
				top: 0px;
				left: 0px;
				transform: rotate(-15deg);
			}
			#played3 {
				position:absolute;
				top: 40px;
				left: 40px;
				transform: rotate(2deg);
			}			
			#played2 {
				position:absolute;
				top: -3px;
				left: 80px;
				transform: rotate(11deg);
			}			
			#score {
			    position: absolute;
			    top: 140px;
			    left: 200px;
			    font-size: xx-large;
			    font-weight: bolder;
			    color: white;
			    background-color: gray;
			    border-radius: 10px;
			    padding: 20px;
			    visibility: hidden;
			}
		</style>
</head>
<body>
	<form id="search-form" onsubmit="return false">
		<input type="submit" value="Start" onclick="start()" />
	</form>

	<div id="bidding" style="display: none;">
		<button id="bidBtn" class="btn">XX</button>
		<button id="passBtn" class="btn">Pass</button>
	</div>
	<div id="bidn1" class="bidn">
		<div class="name">Bob</div>
		<div id="bid1"></div>
	</div>

	<div id="bidn2">
		<div class="name">Ana</div>
		<div id="bid2"></div>
	</div>

	<div id="bidn3">	
		<div class="name">You</div>
		<div id="bid3"></div>
	</div>

	<div id="played"></div>
	<div id="discard1"></div>
	<div id="discard2"></div>
	<div id="played"></div>
	<div id="cards"></div>
	<div id="score"></div>
<script type="text/javascript" src="/html/jquery-3.2.1.min.js"></script>
<script type="text/javascript">

	function start() {
		var score = document.getElementById("score")
		score.style["visibility"] = "hidden";

		$("#bid1").empty();
		$("#bid2").empty();
		$("#bid3").empty();
		$("#cards").empty();
				
		$.ajax({
			url: "/start",
			method: "GET",
			success: handleInitData,
		});
		return false;
	}

// FORE = 0, MID=1, BACK=2
	var passed = [false, false, false]
	var biddiv = ["#bid1", "#bid2", "#bid3"]
	var playerIndex= [1,2,3]

	var gamePosition = -1
	var secondRound = false;
	var parsedBid = ""
	var acceptedBid = ""
	var playerHand= []
	var declarer =  -1

	function handleInitData(rawData) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		createImgCards(parsed.Hand);

		gamePosition = parsed.Position
		console.log("Position "+ gamePosition);
		if (gamePosition == 0) {
			biddiv = ["#bid3", "#bid1", "#bid2"]
			playerIndex = [3, 1, 2]
			$("#bidn1").removeClass("dealer");
			$("#bidn2").addClass("dealer");
			$("#bidn3").removeClass("dealer");
		}
		if (gamePosition == 1) {
			biddiv = ["#bid2", "#bid3", "#bid1"]
			playerIndex = [2, 3, 1]

			$("#bidn1").addClass("dealer");
			$("#bidn2").removeClass("dealer");
			$("#bidn3").removeClass("dealer");
		}
		if (gamePosition == 2) {
			biddiv = ["#bid1", "#bid2", "#bid3"]
			playerIndex = [1, 2, 3]
			$("#bidn1").removeClass("dealer");
			$("#bidn2").removeClass("dealer");
			$("#bidn3").addClass("dealer");
		}				
		passed = [false, false, false]
		secondRound = false;
		parsedBid = ""
		acceptedBid = ""
		trickRound = 0
		declarer = -1
		for (var i=1; i <=3 ; i++) {
			var d = document.getElementById("bidn" + i)
			d.style["background"] = "yellow"			
		}
		MidVsFore();
	}

	function pickUpSkat(player) {
		console.log("PICKING UP...")
		Promise.resolve($.ajax({
				url: "/getTrump",
				method: "GET",
				success: function(rawdata) {
					var parsed = JSON.parse(rawdata);
					if (!parsed) return;	
					var trump = parsed	
					console.log("TRUMP: " + trump)
					$(biddiv[player]).append($("<div>" + trump + "</div>"));					
				}
		})).then(function(response) {
			Promise.resolve($.ajax({
				url: "/getHand/" + gamePosition,
				method: "GET",
				success: function(rawdata) {
					var parsed = JSON.parse(rawdata);
					if (!parsed) return;	
					console.log("Hand :" + parsed)
					createImgCards(parsed);
				}
			})).then(function(response) {
				cardsPlayed = 0;
				$("#played").empty();
				trick();				
			})

		})	
	}

	var cardsPlayed = 0
	var trickRound = 0

	function gameFinished() {
		return trickRound > 30
	}

	function getScore() {
		$.ajax({
			url: "/getScore",
			method: "GET",
			success: function(rawdata) {
				var parsed = JSON.parse(rawdata);
				if (!parsed) return;
				var score = document.getElementById("score")
				score.style["visibility"] = "visible"
				score.innerHTML = parsed.DeclarerPoints + " - " + parsed.DefenderPoints + ", Score: " + parsed.GameScore;
			},
		})	
	}

	function trick() {
			trickRound++
			if (gameFinished()) {
				console.log("Game finished");
				getScore();
				trickRound = 0;
				return
			}
			console.log("Sending getCardPlayed to server, cardsPlayed:" + cardsPlayed)
			Promise.resolve($.ajax({
				url: "/getCardPlayed",
				method: "GET",
				success: function(data) {
					playCard(data);
				},
			}))
			.then(nextTrick);
	}

	function nextTrick(response) {
			cardsPlayed++;
			if (cardsPlayed < 3 ) {
				var el = document.getElementById("played");
				el.style["transition"] = "1s ease-in-out";
				trick();
			} else {
				getTrickWinner()
				//.then(animate)
				.then(delayfn(2000))
				.then(function() {
				//	console.log("TimeOut ended")
					var el = document.getElementById("played");
					el.style["visibility"] = "hidden";
					el.style["transition"] = "0s";
				})
				.then(delayfn(2000))
				.then(function (response) {
				//	console.log("AFTER TIMEOUT")
					$("#played").empty();
					showPlayed()
					cardsPlayed = 0;
					trick();
				})
			} 
					
	}

	function delay(t) {
		return new Promise(function(resolve) {
			// console.log("Starting timer");
			setTimeout(function() {
				// console.log("TIMED OUT")
				resolve("OVER")
			}, t);
		});
	}

	function delayfn(t) {
		// code that it is not within the function is executed immediately. Not after THEN
		// console.log("delayfn Called " + t) 
		return function() {
			return delay(t);
		}
	}

	function animate() {
		// var el = document.getElementById("played");
		// el.style["transform"] = "rotate(0deg) translate(-150px,30px) scale(0.4)";	
		// el.style["transform"] = "rotate(0deg) translate(150px,30px) scale(0.4)";	
		// el.style["transform"] = "rotate(0deg) translate(0px,150px) scale(0.4)";	
	}


	function getTrickWinner() {
		return Promise.resolve($.ajax({
				url: "/getTrickWinner",
				method: "GET",
				success: function(rawdata) {
					var parsed = JSON.parse(rawdata);
					if (!parsed) return;	
					var winner = parsed	
					console.log("WINNER: " + parsed)

					var el = document.getElementById("played");

					if (winner == "Bob") {
						playerIndex = [1, 2, 3];
						el.style["transform"] = "rotate(0deg) translate(-150px,30px) scale(0.4)";	
					}
					else if (winner == "Ana") {
						playerIndex = [2, 3, 1];
						el.style["transform"] = "rotate(0deg) translate(150px,30px) scale(0.4)";	
					}
					else {
						playerIndex = [3, 1, 2];	
						el.style["transform"] = "rotate(0deg) translate(0px,150px) scale(0.4)";	
					}
				}
			}))		
	}

	function playCard(rawdata) {
		var parsed = JSON.parse(rawdata);
		if (!parsed) return;					

		var played = $("#played");
		var name = parsed.C.Suit +parsed.C.Rank;
		var pi = playerIndex[parsed.Pi];
		console.log("getCardPlayed: " + name+ "player:" + parsed.Pi)
		var img = $("<img id='played" + pi + "' class='card' src='/html/img/" + name + ".png' />");
		played.append(img)				
	}

	function showPlayed() {
		var el = document.getElementById("played");
		el.style["transition"] = "0s";
		el.style["WebkitTransform"] = "";					
		el.style["transform"] = "";					
		el.style["visibility"]= "visible"
		el.style["transition"] = "0s ease-in-out";
	}

//
// BIDING
//
	function MidVsFore() {
		console.log("calling MIDBID")
		getBid(1).then(function(response) {
			console.log("MIDBID responded")
			if (!passed[1]) {
				console.log("Mid Not passed")
				console.log("calling FOREBID")
				getBid(0).then(function(response) {
					console.log("FOREBID responded")
					if (!passed[0]) {
						console.log("Fore Not passed")
						MidVsFore()	
					} else {
						console.log("Fore passed")
						secondRound = true;
						BackVsMid();						
					}
				});
			} else {
				console.log("Mid Passed")
				secondRound = true;
				BackVsFore();				
			}
		});
	}

	function BackVsFore() {
		console.log("calling BACKBID")
		getBid(2).then(function(response) {
			console.log("BACKBID responded")
			if (!passed[2]) {
				console.log("Back NOT passed")
				console.log("calling FOREBID")
				getBid(0).then(function(response) {
					console.log("FOREBID responded")
					if (!passed[0]) {
						console.log("Fore NOT passed")
						BackVsFore();
					} else {
						console.log("Fore passed")
						console.log("BACK WON")
						setDeclarer(2);			
					}		
				});
			} else {
				console.log("Back passed")
				// TODO: if mid and back passed immediately
				// check that FORE accepts the 18 bid.
				if (acceptedBid == "") {
					getBid(0).then(function(response) {
						if (passed[0]) {
							console.log("ALL PASSED")
							emptyBidDivsExcept(-1);
							return
						} else {
								console.log("FORE WON" + acceptedBid);
								setDeclarer(0);	
								return								
						}
					})
				} else {
					console.log("FORE WON" + acceptedBid);
					setDeclarer(0);	
					return						
				}
			}
		});
	}

	function BackVsMid() {
		console.log("calling BACKBID")
		getBid(2).then(function(response) {
			console.log("BACKBID responded")
			if (!passed[2]) {
				console.log("calling MIDBID")
				getBid(1).then(function(response) {
					console.log("MIDBID responded")
					if (!passed[1]) {
						console.log("MID NOT passed")
						BackVsMid();
					} else {
						console.log("MID passed")
						console.log("BACK WON")
						setDeclarer(2);			
					}
				});
			} else {
				console.log("Back passed")
				if (acceptedBid == "") {
					getBid(1).then(function(response) {
						if (!passed[1]) {
							console.log("ALL PASSED")
							emptyBidDivsExcept(-1);
							return
						} else {
							console.log("MID WON" + acceptedBid);
							setDeclarer(1);	
							return								
						}
					})
				} else {
					console.log("MID WON" + acceptedBid);
					setDeclarer(1);	
				}									
			}
		});
	}

	function setDeclarer(player) {
		($.ajax({
				url: "/declarer/" + player + "/" + acceptedBid,
				method: "GET",
				success: function(rawdata) {
					console.log("Declarer set:" + player + " BID: " + acceptedBid)
					var d = document.getElementById("bidn" + playerIndex[player])
					d.style["background"] = "orange"
					var bid = document.getElementById("bid" + playerIndex[player])
					console.log("Setting: element: " + "bid" + playerIndex[player])
					emptyBidDivsExcept(player);
					$(biddiv[player]).empty();
					var bid = $(biddiv[player]);
					console.log("APPENDING accepted bid: "+acceptedBid)
					bid.append($("<span>Bid: " + acceptedBid + "</span>"));
					//
					// continue with pick up skat
					//
					declarer = player
					pickUpSkat(player);
				},
			}));
	}

	// function emptyBidDivsExcept(p) {
	// 	for (var i = 0; i <= 2; i++) {
	// 		if (i != p) {
	// 			console.log("EMptying div: " + biddiv[i])
	// 			$(biddiv[i]).empty();
	// 		}
	// 	}
	// }

	function emptyBidDivsExcept(p, t) {
		setTimeout(function() {
			for (i = 0; i < 3; i++) {
				if (i != p && i != declarer) {
					$(biddiv[i]).empty();
	 				// console.log("EMptying div: " + biddiv[i] + "declarer: " + declarer)
				}
			}
		}, t);	
	}

	function inputPromise(player) {
		return new Promise(function(resolve, reject) {
			Promise.resolve($.ajax({
				url: "/getbidvalue/" + player,
				method: "GET",
				success: function(rawdata) {
						var parsed = JSON.parse(rawdata);
						if (!parsed) return;
						parsedBid = parsed.Bid;
					},
			})).then(function(response) {
				console.log("jsPromise returned. Bid: " + parsedBid);
				$("#bidding").show();

				var bidBtn = document.getElementById("bidBtn")
				var passBtn = document.getElementById("passBtn")
				if (player == 0 || (player == 1 && secondRound)) {
					text = "Yes (" + parsedBid + ")"
				} else {
					text = parsedBid
				}					
				bidBtn.innerHTML = text;
				bidBtn.addEventListener('click', function() {
					console.log("BTN ACCEPTED")
					acceptedBid = parsedBid
					$("#bidding").hide();
					emptyBidDivsExcept(player, 500);
					resolve("OK")
				}) 
				passBtn.addEventListener('click', function() {
					passed[player] = true
					$("#bidding").hide();
					emptyBidDivsExcept(player, 500);
					resolve("PASS")
				}) 	
			})
		});
	}

	function getBid(player) {
		if (gamePosition == player) {
			return inputPromise(player);
		} else {		
			return Promise.resolve($.ajax({
				url: "/bid/" + player,
				method: "GET",
				success: function(rawdata) {
					handleBidData(rawdata, player)
				},
			}));		
		}
	}
	function handleGetBidData(rawData, player) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		parsedBid = parsed.Bid
	}
		
	function handleBidData(rawData, player) {
		var parsed = JSON.parse(rawData);
		if (!parsed) return;
		console.log("player " + player + ": Bid "+ parsed.Bid + " Accepted " + parsed.Accepted);
		var bid = $(biddiv[player]);
		bid.empty();

		parsedBid = parsed.Bid
		if (parsed.Accepted) {
			passed[player] = false
			console.log("...ACCEPTED")
			if (player == 0 || (player == 1 && secondRound)) {
				text = "YES (" + parsed.Bid + ")"
			} else {
				text = parsed.Bid
			}
			acceptedBid = parsed.Bid
			emptyBidDivsExcept(player, 500);	
		} else {
			console.log("...PASS")

			text = 'PASS'
			passed[player] = true
		}
		bid.append($("<span>" + text + " </span>"));
	}

//
// CARDS
//
	function createImgCards(hand) {
		playerHand = []
		hand.forEach(function(result) {
			playerHand.push({suit: result.Suit, rank: result.Rank})
		});
		createPlayerHand(playerHand)
	}

	function createPlayerHand(playerHand) {
		var i = 0
		var cards = $("#cards");
		cards.empty();
		noOfCards = playerHand.length;
		offset = 6 - Math.floor(noOfCards/2)
		console.log("OFFSET: "+ offset)
		playerHand.forEach(function(result) {
			var name = result.suit + result.rank
			var img = $("<img id='card_" + (i+1) + "' class='card' src='/html/img/" + name + ".png' onclick='cc(" + i + ")' onmouseover='mo(" + i + ")' onmouseleave='mv(" + i + ")' />"
						);
			cards.append(img)
			placeCard(i, offset)
			i++
		});		
	}

	var card_left = []
	var card_top = []
	var card_rotate = []
	var offset = 1

	var initRotate = -15
	var initTop = -10

	for(var i=0; i < 12; i++) {
		card_left[i] = 0 + i * 50
		card_top[i] = 0 + i * initTop
		card_rotate[i] = "rotate("+ initRotate +"deg)"
		initRotate += 3
		initTop += 1
	}


	for(var i=0; i < 6; i++) {
		middleLeft = 200
		leftStep = 35
		middleTop = 0
		topStep = 1
		rotateStep = 4
		card_left[5-i] = middleLeft - i * leftStep
		card_left[6+i] = middleLeft + (i+1) * leftStep
		card_top[5-i] = middleTop + i * topStep
		card_top[6+i] = middleTop + i * topStep
		card_rotate[5-i] = "rotate("+ (-rotateStep - i *rotateStep) +"deg)"
		card_rotate[6+i] = "rotate("+ ( i * rotateStep) +"deg)"
	}

	function mo(id) {
		var el = document.getElementById("card_" + (id+1));
		el.style["WebkitTransform"] = card_rotate[offset + id] + " translate(0,-1em) scale(1.1)";
	}

	function mv(id) {
		var el = document.getElementById("card_" + (id+1));
		el.style["WebkitTransform"] = card_rotate[offset + id];
	}

	function placeCard(id, offset) {
		var el = document.getElementById("card_" + (id+1));
	//	el.style["zIndex"] = 1000;
		el.className = 'card'
		el.style["left"] = card_left[offset + id] + "px";
		el.style["top"] = card_top[offset + id] + "px";
		if (id == offset) {
			el.style["position"] = "relative"
		} else {
			el.style["position"] = "absolute";
		}
		el.style["WebkitTransform"] = card_rotate[offset + id];
		el.style["transform"] = card_rotate[offset + id];
	//	el.style["zIndex"] = 0;
	}

	var discarded = 0

	function cc(n) {
		var el = document.getElementById("card_" + (n+1));
		// console.log(playerHand[n].suit + " " + playerHand[n].rank)
		$.ajax({
				url: "/playCard/" + gamePosition + "/" + playerHand[n].suit + "/" + playerHand[n].rank,
				method: "GET",
				success: function(rawdata) {
					console.log("Success from server: " + playerHand[n].suit + " " + playerHand[n].rank);
					playerHand.splice(n, 1);
					createPlayerHand(playerHand);					
				},
			});	


	}

	// function cc(n) {
	// 	if (discarded == 2) {
	// 		return
	// 	}
	// 	var el = document.getElementById("card_" + (n+1));
	// 	//el.style["zIndex"] = 1000
	// 	el.style["position"] = "relative";

	// 	el.style["left"] = "0px";
	// 	el.style["top"] = "0px";
	// 	//el.style["transform"] = "scale(1.5)";

	// 	el.style["WebkitTransform"] = "scale(1.5)";
	// 	el.style["transform"] = "scale(1.5)";

	// 	if (discarded === 0) {
	// 		var discard1 = document.getElementById("discard1");
	// 		discard1.appendChild(el)
	// 		discarded = 1
	// 		return
	// 	}

	// 	if (discarded === 1) {
	// 		var discard2 = document.getElementById("discard2");
	// 		discard2.appendChild(el)
	// 		discarded = 2
	// 		return
	// 	}		
	// //	var parent = document.getElementById("cards");
	// //	parent.removeChild(el)
	// }

	//getCards();

</script>
</body>
</html>